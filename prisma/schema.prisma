generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////
/// Master Data
/////////////

///ตารางเก็บข้อมูลสาขา
model org_branch {
  branch_id   Int         @id @default(autoincrement())
  branch_code String      @unique @db.VarChar(20)
  branch_name String      @db.VarChar(200)
  is_active   Boolean     @default(true)
  created_at  DateTime    @default(now())
  updated_at  DateTime    @updatedAt
  warehouses  warehouse[]
  prHeaders   pr_header[]

  @@map("org_branch")
}

///ตารางเก็บข้อมูลคลัง
model warehouse {
  warehouse_id   Int         @id @default(autoincrement())
  branch_id      Int
  warehouse_code String      @unique @db.VarChar(20)
  warehouse_name String      @db.VarChar(200)
  address        String      @db.Text
  is_active      Boolean     @default(true)
  created_at     DateTime    @default(now())
  updated_at     DateTime    @updatedAt
  branch         org_branch  @relation(fields: [branch_id], references: [branch_id])
  prHeaders      pr_header[]

  @@map("warehouse")
}

///ตารางเก็บข้อมูลเจ้าหนี้
model vendor {
  vendor_id         Int     @id @default(autoincrement())
  vendor_code       String  @db.VarChar(30)
  vendor_name       String  @db.VarChar(255)
  tax_id            String? @db.VarChar(20)
  payment_term_days Int
  status            String  @db.VarChar(20)

  @@map("vendor")
}

///ตารางเก็บข้อมูลสินค้า
model item {
  item_id               Int        @id @default(autoincrement())
  item_code             String     @db.VarChar(50)
  item_name             String     @db.VarChar(255)
  item_type             String     @db.VarChar(20)
  uom                   String     @db.VarChar(20)
  itemType              item_type? @relation(fields: [item_typeItem_type_id], references: [item_type_id])
  item_typeItem_type_id Int?

  @@map("item")
}

///ตารางเก็บข้อมูลหน่วยนับ
model uom {
  uom_id    Int       @id @default(autoincrement())
  uom_code  String    @db.VarChar(20)
  uom_name  String    @db.VarChar(100)
  is_active Boolean?
  prLines   pr_line[]

  @@map("uom")
}

///ตารางเก็บข้อมูลประเภทสินค้า
model item_type {
  ///รหัสประเภทสินค้า
  item_type_id      Int       @id @default(autoincrement())
  ///รหัสประเภทสินค้า
  item_type_code    String    @db.VarChar(30)
  ///ชื่อประเภทสินค้า
  item_type_name    String    @db.VarChar(200)
  ///ชื่อประเภทสินค้า (อังกฤษ)
  item_type_nameeng String    @db.VarChar(200)
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt
  items             item[]
  prLines           pr_line[]

  @@map("item_type")
}

///ตารางเก็บข้อมูลศูนย์ต้นทุน
model cost_center {
  ///รหัสศูนย์ต้นทุน
  cost_center_id   Int       @id @default(autoincrement())
  ///รหัสศูนย์ต้นทุน
  cost_center_code String    @db.VarChar(30)
  ///ชื่อศูนย์ต้นทุน
  cost_center_name String    @db.VarChar(200)
  ///โครงการ
  projects         project[]
  prLines          pr_line[]

  @@map("cost_center")
}

///ตารางเก็บข้อมูลโครงการ
model project {
  ///รหัสโครงการ
  project_id     Int         @id @default(autoincrement())
  ///รหัสโครงการ
  project_code   String      @db.VarChar(30)
  ///ชื่อโครงการ
  project_name   String      @db.VarChar(200)
  ///รายละเอียดโครงการ
  description    String
  ///รหัสศูนย์ต้นทุน
  cost_center_id Int
  cost_center    cost_center @relation(fields: [cost_center_id], references: [cost_center_id])
  ///งบประมาณ
  budget_amount  Decimal     @db.Decimal(15, 2)
  ///วันที่เริ่มต้นโครงการ
  start_date     DateTime
  ///วันที่สิ้นสุดโครงการ
  end_date       DateTime
  ///สถานะโครงการ
  status         String      @db.VarChar(20)
  prLines        pr_line[]

  @@map("project")
}

/// ตารางเจ้าหนี้
model vendor_master {
  /// รหัสเจ้าหนี้
  vendor_code           String?   @db.VarChar(20)
  /// ชื่อเจ้าหนี้ (ไทย)
  vendor_name           String?   @db.VarChar(200)
  /// ชื่อเจ้าหนี้ (อังกฤษ)
  vendor_name_en        String?   @db.VarChar(200)
  /// ประเภทเจ้าหนี้ (MANUFACTURER, DISTRIBUTOR, etc.)
  vendor_type           String?   @db.VarChar(30)
  /// หมวดหมู่ธุรกิจ
  category              String?   @db.VarChar(100)
  /// เลขประจำตัวผู้เสียภาษี
  tax_id                String?   @db.VarChar(13)
  /// ชื่อสาขา
  branch_name           String?   @db.VarChar(100)
  /// จดทะเบียน VAT หรือไม่
  is_vat_registered     Boolean?
  /// มีการหัก ณ ที่จ่ายหรือไม่
  wht_applicable        Boolean?
  /// เงื่อนไขการชำระเงิน (วัน)
  payment_term_days     Int?
  /// วงเงินเครดิต
  credit_limit          Decimal?  @db.Decimal(15, 2)
  /// รหัสสกุลเงิน
  currency_code         String?   @db.VarChar(3)
  /// สถานะ (ACTIVE, INACTIVE)
  status                String?   @db.VarChar(20)
  /// เกรดประเมิน (A–E)
  rating                String?   @db.VarChar(1)
  /// คะแนนประเมินผล (0–100)
  performance_score     Decimal?  @db.Decimal(5, 2)
  /// ผู้ติดต่อหลัก
  contact_person        String?   @db.VarChar(100)
  /// เบอร์โทรศัพท์
  phone                 String?   @db.VarChar(20)
  /// เบอร์มือถือ
  mobile                String?   @db.VarChar(20)
  /// อีเมล
  email                 String?   @db.VarChar(100)
  /// เว็บไซต์
  website               String?   @db.VarChar(200)
  /// ที่อยู่
  address               String?
  /// เขต/อำเภอ
  district              String?   @db.VarChar(100)
  /// จังหวัด
  province              String?   @db.VarChar(100)
  /// รหัสไปรษณีย์
  postal_code           String?   @db.VarChar(10)
  /// ประเทศ
  country               String?   @db.VarChar(100)
  /// วันที่ลงทะเบียน
  registration_date     DateTime? @db.Date
  /// วันที่อนุมัติ
  approved_date         DateTime? @db.Date
  /// วันที่ทำธุรกรรมล่าสุด
  last_transaction_date DateTime? @db.Date
  /// มูลค่าการซื้อทั้งหมด
  total_purchase_amount Decimal?  @db.Decimal(15, 2)
  /// หมายเหตุ
  remark                String?
  /// ผู้สร้าง
  created_by            String?   @db.VarChar(50)
  /// วันที่สร้าง
  created_date          DateTime  @default(now())
  /// ผู้แก้ไข
  updated_by            String?   @db.VarChar(50)
  /// วันที่แก้ไข
  updated_date          DateTime  @updatedAt
  /// PK รหัสอ้างอิงเจ้าหนี้
  vendor_id             Int       @id @default(autoincrement())

  /// API layer (พอแล้ว ไม่ต้องมีมากกว่านี้)

  contacts           vendor_contacts[]
  bank_accounts      vendor_bank_accounts[]
  vendorDocuments    vendor_documents[]
  vendorPerformances vendor_performance[]

  @@map("vendor_master")
}

/// ตารางผู้ติดต่อ
model vendor_contacts {
  /// ชื่อผู้ติดต่อ
  contact_name String        @db.VarChar(100)
  /// ตำแหน่ง
  position     String?       @db.VarChar(100)
  /// แผนก
  department   String?       @db.VarChar(100)
  /// เบอร์โทรศัพท์
  phone        String?       @db.VarChar(20)
  /// เบอร์มือถือ
  mobile       String?       @db.VarChar(20)
  /// อีเมล
  email        String?       @db.VarChar(100)
  /// เป็นผู้ติดต่อหลักหรือไม่
  is_primary   Boolean       @default(false)
  /// วันที่สร้างข้อมูล
  created_at   DateTime      @default(now())
  /// วันที่แก้ไขล่าสุด
  updated_at   DateTime      @updatedAt
  /// รหัสผู้ติดต่อ (PK)
  contact_id   Int           @id @default(autoincrement())
  /// รหัสอ้างอิงเจ้าหนี้ (FK → vendor_master.vendor_id)
  vendor_id    Int
  vendor       vendor_master @relation(fields: [vendor_id], references: [vendor_id])

  @@index([vendor_id])
}

/// ตารางเก็บข้อมูลบัญชีธนาคารของเจ้าหนี้
model vendor_bank_accounts {
  /// ชื่อธนาคาร
  bank_name       String        @db.VarChar(100)
  /// สาขาธนาคาร
  bank_branch     String        @db.VarChar(100)
  /// เลขที่บัญชีธนาคาร
  account_no      String        @db.VarChar(30)
  /// ชื่อบัญชี
  account_name    String        @db.VarChar(200)
  /// ประเภทบัญชี SAVING / CURRENT
  account_type    String        @db.VarChar(20)
  /// รหัส SWIFT (ถ้ามี)
  swift_code      String?       @db.VarChar(20)
  /// เป็นบัญชีหลักของเจ้าหนี้หรือไม่
  is_default      Boolean       @default(false)
  /// PK รหัสบัญชีธนาคาร
  bank_account_id Int           @id @default(autoincrement())
  /// FK รหัสอ้างอิงเจ้าหนี้ (FK → vendor_master.vendor_id)
  vendor_id       Int
  vendor          vendor_master @relation(fields: [vendor_id], references: [vendor_id])

  @@index([vendor_id])
  @@map("vendor_bank_accounts")
}

/// ตารางเอกสารประกอบของเจ้าหนี้
model vendor_documents {
  /// ประเภทเอกสาร
  document_type String?       @db.VarChar(50)
  /// เลขที่เอกสาร
  document_no   String?       @db.VarChar(50)
  /// วันที่ออกเอกสาร
  issue_date    DateTime?     @db.Date
  /// วันหมดอายุ
  expiry_date   DateTime?     @db.Date
  /// ที่อยู่ไฟล์
  file_path     String?       @db.VarChar(500)
  /// ชื่อไฟล์
  file_name     String?       @db.VarChar(200)
  /// หมายเหตุ
  remark        String?
  /// วันที่สร้างข้อมูล
  created_at    DateTime      @default(now())
  /// วันที่แก้ไขล่าสุด
  updated_at    DateTime      @updatedAt
  /// รหัสเอกสาร (PK)
  document_id   Int           @id @default(autoincrement())
  /// รหัสอ้างอิงเจ้าหนี้ (FK → vendor_master.vendor_id)
  vendor_id     Int
  vendor        vendor_master @relation(fields: [vendor_id], references: [vendor_id])

  @@index([vendor_id])
  @@map("vendor_documents")
}

/// ตารางบันทึกผลการประเมินเจ้าหนี้
model vendor_performance {
  /// รหัสการประเมิน (PK)
  performance_id    Int           @id @default(autoincrement())
  /// รหัสอ้างอิงเจ้าหนี้ (FK → vendor_master.vendor_id)
  vendor_id         Int
  /// วันที่ประเมิน
  evaluation_date   DateTime?     @db.Date
  /// งวดการประเมิน
  evaluation_period String?       @db.VarChar(20)
  /// คะแนนคุณภาพ
  quality_score     Decimal?      @db.Decimal(5, 2)
  /// คะแนนการส่งมอบ
  delivery_score    Decimal?      @db.Decimal(5, 2)
  /// คะแนนราคา
  price_score       Decimal?      @db.Decimal(5, 2)
  /// คะแนนบริการ
  service_score     Decimal?      @db.Decimal(5, 2)
  /// คะแนนรวม
  total_score       Decimal?      @db.Decimal(5, 2)
  /// เกรดประเมิน
  rating            String?       @db.VarChar(1)
  /// หมายเหตุ
  remark            String?
  /// ผู้ประเมิน
  evaluated_by      String?       @db.VarChar(50)
  /// วันที่สร้างข้อมูล
  created_at        DateTime      @default(now())
  /// วันที่แก้ไขล่าสุด
  updated_at        DateTime      @updatedAt
  vendor            vendor_master @relation(fields: [vendor_id], references: [vendor_id])

  @@map("vendor_performance")
}

/// ตารางหมวดหมู่เจ้าหนี้
model vendor_categories {
  /// รหัสหมวดหมู่ (PK)
  category_id        Int      @id @default(autoincrement())
  /// รหัสหมวดหมู่
  category_code      String?  @db.VarChar(20)
  /// ชื่อหมวดหมู่
  category_name      String?  @db.VarChar(100)
  /// รหัสหมวดหมู่แม่
  parent_category_id String?  @db.VarChar(20)
  /// สถานะการใช้งาน
  is_active          Boolean?

  @@map("vendor_categories")
}

/// ตารางเงื่อนไขการชำระ
model payment_terms {
  /// รหัสเงื่อนไขการชำระ (PK)
  payment_term_id Int      @id @default(autoincrement())
  /// รหัสเงื่อนไข
  term_code       String?  @db.VarChar(20)
  /// ชื่อเงื่อนไข
  term_name       String?  @db.VarChar(100)
  /// จำนวนวัน
  days            Int?
  /// สถานะการใช้งาน
  is_active       Boolean?

  @@map("payment_terms")
}

//////////////
/// Transaction Tables
/////////////

///ตารางเก็บข้อมูลหลักของใบขอซื้อ (Purchase Requisition Header)
model pr_header {
  ///รหัสใบขอซื้อ (PK)
  pr_id             Int      @id @default(autoincrement())
  ///เลขที่ใบขอซื้อ
  pr_no             String   @db.VarChar(30)
  ///วันที่สร้างใบขอซื้อ
  pr_date           DateTime
  ///รหัสสาขา (FK)
  branch_id         Int
  ///รหัสคลัง (FK)
  warehouse_id      Int
  ///วันที่ต้องการ
  need_by_date      DateTime
  ///สถานะ
  status            String   @db.VarChar(20)
  ///รหัสสกุลเงิน
  currency_code     String   @db.VarChar(3)
  ///อัตราแลกเปลี่ยน
  exchange_rate     Decimal  @db.Decimal(18, 2)
  ///หมายเหตุ
  remark            String?  @db.Text
  ///จำนวนเงินรวม ยอดประมาณการ
  total_amount      Decimal  @db.Decimal(18, 2)
  ///เครดิตเทอม (วัน)
  payment_term_days Int?
  ///วันที่สร้าง
  created_at        DateTime @default(now())
  ///วันที่แก้ไขล่าสุด
  updated_at        DateTime @updatedAt

  branch    org_branch @relation(fields: [branch_id], references: [branch_id])
  warehouse warehouse  @relation(fields: [warehouse_id], references: [warehouse_id])
  prLines   pr_line[]
}

/// 
model pr_line {
  pr_line_id Int @id @default(autoincrement())
  line_no    Int

  item_id        Int
  description    String? @db.Text
  pr_id          Int
  qty            Decimal @db.Decimal(18, 3)
  uom_id         Int
  est_unit_price Decimal @db.Decimal(18, 4)

  tax_code              String? @db.VarChar(20)
  cost_center_id        Int
  project_id            Int
  required_receipt_type String? @db.VarChar(20)

  // ======================
  // Relations
  // ======================
  pr          pr_header   @relation(fields: [pr_id], references: [pr_id])
  item        item_type   @relation(fields: [item_id], references: [item_type_id])
  uom         uom         @relation(fields: [uom_id], references: [uom_id])
  cost_center cost_center @relation(fields: [cost_center_id], references: [cost_center_id])
  project     project     @relation(fields: [project_id], references: [project_id])

  @@unique([pr_id, line_no])
  @@index([pr_id])
}
